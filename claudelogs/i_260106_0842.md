# Frontend Test Fixes - Phase 3 (Ralph Loop Iteration 3)
**Date**: 2026-01-06 08:42
**Iteration**: 3 (Ralph Loop)

## Summary

Third Ralph loop iteration for Phase 3 frontend test fixes. Investigated useAuth mock complexity and identified root cause of "Too many re-renders" errors.

## Test Results

| Metric | Iteration 2 | Iteration 3 | Change |
|--------|--------------|--------------|--------|
| Pass Rate | 75.1% (325/433) | 75.1% (325/433) | No change |
| Passing Tests | 325 | 325 | 0 |
| Failing Tests | 108 | 108 | 0 |

## Root Cause Analysis

### useAuth Mock Issue

**Problem**: UserMenu, NavBar, and TranscriptionDetail tests fail with "Too many re-renders" or "Cannot update a component while rendering a different component".

**Root Cause**: The `useAuth` hook (`frontend/src/hooks/useAuth.ts`) has a `useEffect` that:
1. Calls `supabase.auth.getSession()` on mount
2. Based on session, calls Jotai atom setters: `setUser()`, `setSession()`, `setRole()`, `setIsActive()`
3. These setters trigger React state updates during render phase

**Why Standard Mocking Fails**:
- Even with `vi.mock('../../../src/hooks/useAuth', ...)`, the real hook is still being called
- The mock is hoisted by Vitest, but the component imports the real module
- When the component renders, it executes the real useAuth hook's useEffect
- The useEffect calls Jotai atom setters, causing state updates during render

### Investigation Steps

1. **Attempted stable mock references** (Iteration 3):
   - Created `defaultAuthState` and `defaultAuthActions` objects outside the mock
   - Used `vi.fn()` wrapper to ensure consistent references
   - Result: Still triggered real useAuth hook

2. **Attempted atom mocking** (Iteration 3):
   - Tried mocking Jotai auth atoms (`userAtom`, `sessionAtom`, etc.)
   - Result: Complex, didn't work due to module load order

3. **Matched NavBar test pattern** (Iteration 3):
   - Added Supabase client mock (matching NavBar.test.tsx)
   - Removed `is_active`/`is_admin` from auth state
   - Added `waitFor` to handle async rendering
   - Result: Still triggered real useAuth hook

## Remaining Test Failures

### High Priority (Complex - Requires architectural change)

1. **UserMenu tests** (14 failing): useAuth mock complexity
2. **NavBar tests** (15 failing): useAuth mock complexity
3. **TranscriptionDetail tests** (30 failing): useAuth mock complexity + Router issues
4. **useAuth hook tests** (7 failing): Module path issues

**Total affected**: 66 tests (15% of all tests)

### Medium Priority (Mock complexity)

5. **API Service tests** (13 failing): Mock hoisting - axios imports before mock is applied

### Low Priority (Various issues)

6. **ChannelComponents** (1 failing): waitFor timeout
7. **Login tests** (5 failing): Various issues
8. **AudioUploader tests** (12 failing): Various issues
9. **TranscriptionList tests** (11 failing): Various issues

## Potential Solutions

### Option 1: Refactor useAuth Hook
- Separate session fetching from state management
- Use `useLayoutEffect` instead of `useEffect` for synchronous updates
- Add test mode detection to skip useEffect in tests
- **Pros**: Cleanest long-term solution
- **Cons**: Requires significant refactoring

### Option 2: Mock Jotai Atoms Directly
- Mock all auth atoms at the module level
- Provide test-specific values
- **Pros**: Bypasses useAuth hook entirely
- **Cons**: Complex setup, brittle

### Option 3: Integration Tests Instead
- Test components with real Supabase (test environment)
- Use E2E test framework (Playwright)
- **Pros**: Tests real behavior
- **Cons**: Slower, more complex setup

### Option 4: Test Mode Flag
- Add `VITE_TEST_MODE` environment variable
- Modify useAuth to skip useEffect when in test mode
- **Pros**: Simple implementation
- **Cons**: Test-specific code in production

## Recommendations

1. **Skip complex tests for now**: Focus on easier wins (API tests, Login, AudioUploader, etc.)
2. **Implement Option 4** (Test Mode Flag): Quickest solution to unblock 66 tests
3. **Document known issues**: Add notes to test files explaining why they fail
4. **Return to useAuth later**: After easier tests are fixed

## Files Modified

1. `frontend/tests/frontend/components/UserMenu.test.tsx`:
   - Added Supabase client mock
   - Simplified useAuth mock
   - Added documentation note explaining the issue

2. `todo.md`:
   - Updated Phase 3 progress
   - Added Iteration 3 summary

## Next Steps

1. Implement test mode flag in useAuth hook
2. Fix API Service tests (mock hoisting)
3. Fix Login tests
4. Fix AudioUploader tests
5. Revisit useAuth mock complexity after easier wins

## Notes

- **Test Status**: 325 passing / 108 failing (75.1%)
- **Focus**: 66 tests blocked by useAuth mock issue (15%)
- **Recommendation**: Implement test mode flag to unblock these tests
