# Docker Compose for E2E Testing Against Production Server
#
# This setup runs E2E tests in a Docker container that:
# 1. Uses SSH local port forwarding to bypass Cloudflare
# 2. Forwards localhost:8130 → server:localhost:3080 (nginx)
# 3. Server sees requests from 127.0.0.1 → triggers localhost auth bypass
# 4. Tests against http://localhost:8130 (direct server access)

services:
  e2e-test:
    build:
      context: ./e2e
      dockerfile: Dockerfile
    container_name: whisper_e2e_prd_test
    environment:
      FRONTEND_URL: "${FRONTEND_URL:-http://localhost:8130}"
      PRODUCTION_SERVER: "${PRODUCTION_SERVER:-root@192.3.249.169}"
      SSH_KEY_PATH: "${SSH_KEY_PATH:-/root/.ssh/id_ed25519}"
      TEST_ENVIRONMENT: production
    volumes:
      - ./e2e:/app
      - ../data:/app/data
      - ../testdata:/app/testdata
      - ~/.ssh/id_ed25519:/root/.ssh/id_ed25519:ro
      - ~/.ssh/id_ed25519.pub:/root/.ssh/id_ed25519.pub:ro
      - ~/.ssh/known_hosts:/root/.ssh/known_hosts:ro
      - /app/node_modules
    working_dir: /app
    command: /bin/sh -c "tail -f /dev/null"
    # Use host network to access SSH tunnel on localhost:8130
    network_mode: host
