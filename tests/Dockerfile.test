# Test Runner Dockerfile for Remote Production Testing
#
# This image contains pytest and SSH client for testing
# the production server via SSH + docker exec.

FROM python:3.12-slim

WORKDIR /app

# Install SSH client and other utilities
RUN apt-get update && apt-get install -y --no-install-recommends \
    ssh-client \
    openssh-client \
    curl \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Copy server requirements for test dependencies
COPY server/requirements.txt /tmp/requirements.txt

# Install Python testing dependencies and server dependencies
RUN pip install --no-cache-dir \
    pytest==9.0.2 \
    pytest-asyncio==1.3.0 \
    pytest-cov==7.0.0 \
    pytest-mock==3.14.0 \
    httpx==0.27.0 \
    requests==2.31.0 \
    && pip install --no-cache-dir -r /tmp/requirements.txt

# Copy test utilities
COPY tests/conftest.prd.py /app/conftest.py
COPY tests/utils/ /app/utils/

# Create directory for test outputs
RUN mkdir -p /app/test-results

# Default command (keep container running)
CMD ["/bin/sh", "-c", "tail -f /dev/null"]
